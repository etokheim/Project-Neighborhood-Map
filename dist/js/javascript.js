function readMore(e){displays.featured.toggleAvailable(e),infoWindow.closeAll(),zoomToMarker(e)}function zmoothZoom(e,i,t,r,a,o){isZooming=!0,o=o||function(){};var s,n=map.zoom,l=Math.abs(n)-Math.abs(e);s=n<e?1:-1,!stopZooming&&isZooming?Math.abs(l)>1?(map.panTo(getOffsetCenter(i,t,r)),setTimeout(function(){zmoothZoom(e,i,t,r,a,o),map.setZoom(n+1*s),map.setCenter(getOffsetCenter(i,t,r))},250)):(isZooming=!1,map.setZoom(e),map.setCenter(getOffsetCenter(i,t,r)),setTimeout(function(){"Fjelltur"==markers()[a].type.keywords[0]?map.setMapTypeId("satellite"):map.setMapTypeId("roadmap")},150),setTimeout(function(){o()},settings.featuredMaximizeDelay)):(stopZooming=!1,isZooming=!1)}function zoomToMarker(e){var i=($(".featured_container").outerWidth()+80)/2;setTimeout(function(){zmoothZoom(settings.zoomInAmount,markers()[e].position,i,0,e,displays.featured.maximize)},200)}function getOffsetCenter(e,i,t){if("none"!==$(".featured_minimize").css("display"))return e;var r=Math.pow(2,map.getZoom()),a=map.getProjection().fromLatLngToPoint(e),o=new google.maps.Point(i/r||0,t/r||0),s=new google.maps.Point(a.x-o.x,a.y+o.y);return newCenter=map.getProjection().fromPointToLatLng(s)}function resetZoomAndMap(){for(var e=new google.maps.LatLngBounds,i=0;i<markers().length;i++)e.extend(markers()[i].position);map.fitBounds(e),map.setMapTypeId("roadmap")}function focusMarker(e){displays.locationSwitcher.displayTip(!1);var i=markers()[e];focusedMarker(e),moveToMarker(markers()[e]),infoWindow.closeAll(i),infoWindow.populate(i,new google.maps.InfoWindow),toggleBounce(i)}function moveToMarker(e){var i={lat:e.position.lat(),lng:e.position.lng()};map.panTo(i)}function toggleBounce(e){null!==e.getAnimation()?e.setAnimation(null):e.setAnimation(google.maps.Animation.BOUNCE)}function initMap(){function e(){for(var e=new google.maps.LatLngBounds,i=0;i<markers().length;i++)markers()[i].setMap(map),e.extend(markers()[i].position);map.fitBounds(e)}console.log("Creating the map");var i=[{featureType:"water",stylers:[{color:"#19a0d8"}]},{featureType:"administrative",elementType:"labels.text.stroke",stylers:[{color:"#ffffff"},{weight:6}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#e85113"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#efe9e4"},{lightness:-40}]},{featureType:"transit.station",stylers:[{weight:9},{hue:"#e85113"}]},{featureType:"road.highway",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"labels.text.stroke",stylers:[{lightness:100}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{lightness:-100}]},{featureType:"poi",elementType:"geometry",stylers:[{visibility:"on"},{color:"#f0e4d3"}]},{featureType:"road.highway",elementType:"geometry.fill",stylers:[{color:"#efe9e4"},{lightness:-25}]}];map=new google.maps.Map(document.getElementById("map"),{center:{lat:40.7413549,lng:-73.9980244},styles:i,mapTypeControl:!1});for(var t=0;t<favoriteLocations.length;t++){var r=new google.maps.Marker({position:favoriteLocations[t].location,title:favoriteLocations[t].title,koTitle:ko.observable(favoriteLocations[t].title),animation:null,index:t,type:favoriteLocations[t].type,koVisible:ko.observable(!0),foursquareID:favoriteLocations[t].foursquareID,wikipedia:{hasContent:ko.observable(!1),url:ko.observable(""),ingress:ko.observable(""),bodyText:ko.observable(""),error:{hasError:ko.observable(!1),message:ko.observable("Kunne ikkje nå Wikipedia. Dersom du trur det er ein feil i programmet; vennligst ta kontakt og vis til feilmeldingane i konsollen. (f12).")}},flickr:{img:ko.observableArray([]),hasContent:ko.observable(!1),error:{hasError:ko.observable(!1),img:ko.observableArray([{url:"img/flickr-error.svg",credit:{name:"Kan ikkje nå Flickr"}}])}},foursquare:{error:{hasError:ko.observable(!1),message:ko.observable("Kunne ikkje nå Foursquare. Dersom du trur det er ein feil i programmet; vennligst ta kontakt og vis til feilmeldingane i konsollen. (f12)."),img:ko.observableArray([{url:"img/foursquare-error.svg",credit:{name:"Kan ikkje nå Foursquare"}}])},hasContent:ko.observable(!1),venue:ko.observable(),img:ko.observableArray([]),rating:ko.observable(),starCount:5,price:ko.observable(""),getRating:function(){this.rating("");for(var e=this.venue().rating,i=Math.round(e/2),t=0;t<5;t++)i>t?this.rating(this.rating()+'<i class="fa fa-star" data-bind=""></i>'):this.rating(this.rating()+'<i class="fa fa-star-o" data-bind=""></i>')},getPrice:function(){var e=void 0!==this.venue().price?this.venue().price.tier:"";1==e?this.price("Billig"):2==e?this.price("Ganske billig"):3==e?this.price("Dyrt"):4==e?this.price("Veldig dyrt"):this.price("Ukjent prisklasse")},calculate:function(){this.getRating(),this.getPrice()}},openweathermap:{hasContent:ko.observable(!1),data:ko.observable(),error:{hasError:ko.observable(!1),message:ko.observable("Kunne ikkje nå OpenWeatherMaps. Dersom du trur det er ein feil i programmet; vennligst ta kontakt og vis til feilmeldingane i konsollen. (f12).")}},getImages:function(){return this.foursquare.error.hasError()?this.foursquare.error.img():this.foursquare.hasContent()?this.foursquare.img():this.flickr.error.hasError()?this.flickr.error.img():this.flickr.img()},tipIsPositive:function(){return"disliked"!=this.authorInteractionType}});r.addListener("click",function(){this.infoWindow&&null!==this.infoWindow.anchor?this.infoWindow.close():(infoWindow.closeAll(this),infoWindow.populate(this,new google.maps.InfoWindow)),toggleBounce(this),focusMarker(this.index)}),markers.push(r)}e(),ajax.getExternalResources()}var settings={featuredMaximizeDelay:750,zoomInAmount:14,slick:{featured:{infinite:!0,slidesToShow:1,autoplay:!0,autoplaySpeed:5e3,draggable:!0,arrows:!0,dots:!1,slidesToShow:1,centerMode:!1,variableWidth:!1},locationSwitcher:{speed:300,infinite:!0,slidesToShow:1,autoplay:!1,draggable:!0,dots:!1,arrows:!1}}},map,locations,focusedMarker,mapSettings,markers=ko.observableArray(),focusedMarker=ko.observable(0),screen={size:ko.observable(),updateSize:function(){"none"!==$(".featured_minimize").css("display")?screen.size("small"):screen.size("large")}};screen.updateSize();var displays={locationList:{displaying:ko.observable(!0),toggle:function(e){displays.locationSwitcher.displayTip(!1),"hide"===e?displays.locationList.displaying(!1):displays.locationList.displaying(!displays.locationList.displaying())}},locationSwitcher:{displaying:ko.observable(!0),displayList:ko.observable(!0),displayTip:ko.observable(!0),toggle:function(){displays.locationSwitcher.displaying(!displays.locationSwitcher.displaying())}},featured:{displaying:ko.observable(!1),container:[{displaying:ko.observable(!1),minimized:ko.observable(!1),index:ko.observable(0)},{displaying:ko.observable(!1),minimized:ko.observable(!1),index:ko.observable(0)}],toggle:function(e){displays.featured.displaying(e),setTimeout(function(){displays.featured.displaying()!==!1&&displays.featured.container[e].displaying(!displays.featured.container[e].displaying()),displays.featured.container[e].minimized(!1),"small"==screen.size()&&displays.featured.container[e].minimized(!0)},1)},hide:function(){displays.featured.container[displays.featured.displaying()].minimized(!1),displays.locationSwitcher.toggle(),displays.featured.container[displays.featured.displaying()].displaying(!1),displays.featured.displaying(!1),displays.featured.wikipedia.displaying(!1),isZooming?(stopZooming=!0,setTimeout(function(){resetZoomAndMap()},250)):resetZoomAndMap()},toggleMinimize:function(){displays.featured.container[displays.featured.displaying()].minimized(!displays.featured.container[displays.featured.displaying()].minimized())},minimize:function(){displays.featured.container[displays.featured.displaying()].minimized(!0)},maximize:function(){displays.featured.container[displays.featured.displaying()].minimized(!1)},toggleAvailable:function(e){displays.featured.displaying()===!1?(displays.featured.toggle(0),displays.locationSwitcher.toggle(),displays.locationList.toggle("hide")):0===displays.featured.displaying()?(displays.featured.toggle(0),displays.featured.toggle(1)):1===displays.featured.displaying()&&(displays.featured.toggle(1),displays.featured.toggle(0)),displays.featured.populate(displays.featured.displaying(),e),$(".article_body").on("dblclick",function(e){displays.featured.wikipedia.toggle(),window.getSelection&&(window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges())}),setTimeout(function(){slickCarousel.reslick($(".featured_image_container"),settings.slick.featured)},600)},populate:function(e,i){displays.featured.container[e].index(i)},wikipedia:{displaying:ko.observable(!1),toggle:function(e){displays.featured.wikipedia.displaying(!displays.featured.wikipedia.displaying())}}}},slickCarousel={reslick:function(e,i){e.attr("class").indexOf("slick")!==-1&&e.eq(0).slick("unslick"),e.eq(0).slick(i)},rebind:function(e){e.on("beforeChange",function(e,i,t,r){focusMarker(slickCarousel.convert.index.carouselToMarker(r))})},swipeList:{next:function(){$(".location_switcher_swipe_list").slick("slickNext")},previous:function(){$(".location_switcher_swipe_list").slick("slickPrev")}},convert:{index:{markerToCarousel:function(e){for(var i=!1,t=markers()[e],r=filter.markers().length,a=0;a<r;a++){var o=filter.markers()[a];if(t.title==o.title)return i=!0,a}i||console.error("Can't scroll to "+t.title+" because it's currently not in the swipe list.")},carouselToMarker:function(e){for(var i=!1,t=filter.markers()[e],r=markers().length,a=0;a<r;a++){var o=markers()[a];if(void 0!==t&&void 0!==o&&t.title==o.title)return i=!0,a}if(!i)return 0}}},swipeListGoTo:function(e){$(".location_switcher_swipe_list").slick("slickGoTo",e)}},filter={markers:ko.observableArray([]),type:{hike:ko.observable(!1),restaurant:ko.observable(!1),landmark:ko.observable(!1),toggleHike:function(){this.hike(!this.hike()),filter.apply($(".location_switcher_search_field").val())},toggleRestaurant:function(){this.restaurant(!this.restaurant()),filter.apply($(".location_switcher_search_field").val())},toggleLandmark:function(){this.landmark(!this.landmark()),filter.apply($(".location_switcher_search_field").val())}},getKeywords:function(e){return"hike"===e?{keywords:["Fjelltur","Tur"],icon:"fa fa-compass fa-lg"}:"restaurant"===e?{keywords:["Restaurant"],icon:"fa fa-cutlery fa-lg"}:"landmark"===e?{keywords:["Severdighet"],icon:"fa fa-map-marker fa-lg"}:void 0},active:function(){return!!(this.type.hike()||this.type.restaurant()||this.type.landmark())},apply:function(e){for(var i=[],t=0;t<markers().length;t++)filter.active()?(filter.markerVisibillity(markers()[t],!1),"Fjelltur"==markers()[t].type.keywords[0]&&filter.type.hike()?(filter.markerVisibillity(markers()[t],!0),i.push({title:markers()[t].koTitle(),index:t})):"Restaurant"==markers()[t].type.keywords[0]&&filter.type.restaurant()?(filter.markerVisibillity(markers()[t],!0),i.push({title:markers()[t].koTitle(),index:t})):"Severdighet"==markers()[t].type.keywords[0]&&filter.type.landmark()&&(filter.markerVisibillity(markers()[t],!0),i.push({title:markers()[t].koTitle(),index:t}))):(filter.markerVisibillity(markers()[t],!0),i.push({title:markers()[t].koTitle(),index:t}));filter.search(e,i)},markerVisibillity:function(e,i){e.koVisible(i),e.setVisible(i)},search:function(e,i){filter.markers([]),e=e.toLowerCase(),infoWindow.closeAll();i.filter(function(i){i.title=i.title.toLowerCase();for(var t=-1,r=0;r<e.length;r++){var a=e[r];if(" "!=a&&(t=i.title.indexOf(a,t+1),t==-1))return filter.markerVisibillity(markers()[i.index],!1),!1}return filter.markers.push(markers()[i.index]),!0});displays.locationSwitcher.displayList(!1),displays.locationSwitcher.displayList(!0),slickCarousel.reslick($(".location_switcher_swipe_list"),settings.slick.locationSwitcher),slickCarousel.rebind($(".location_switcher_swipe_list"));for(var t=$(".slick-slide"),r=t.length,a=r;a>0;a--){var o=t.eq(a).children().length;if(o<1){var s=t.eq(a).attr("data-slick-index");$(".location_switcher_swipe_list").slick("slickRemove",s)}}}};window.onload=function(){slickCarousel.reslick($(".location_switcher_swipe_list"),settings.slick.locationSwitcher),setTimeout(function(){displays.locationList.toggle(),displays.locationSwitcher.displayTip(!0)},500),filter.apply($(".location_switcher_search_field").val())},window.onresize=function(e){screen.updateSize()},$(".location_switcher_search_field").on("input",function(){filter.apply(this.value)});var ViewModel=function(){this.closeAndGoToMarker=function(){filter.markers().length>1?slickCarousel.swipeListGoTo(slickCarousel.convert.index.markerToCarousel(this.index)):focusMarker(slickCarousel.convert.index.markerToCarousel(this.index)),displays.locationList.toggle()},$("#location_switcher_center").click(function(){displays.locationList.toggle()})};ko.applyBindings(new ViewModel);var favoriteLocations=[{title:"Sverd i fjell",type:filter.getKeywords("landmark"),location:{lat:58.9413738,lng:5.6713647}},{title:"Stavanger domkirke",type:filter.getKeywords("landmark"),location:{lat:58.9696008,lng:5.7327193}},{title:"Langfossen",type:filter.getKeywords("landmark"),location:{lat:59.8454932,lng:6.339577}},{title:"Låtefossen",type:filter.getKeywords("landmark"),location:{lat:59.9475823,lng:6.5847937}},{title:"Baroniet Rosendal",type:filter.getKeywords("landmark"),location:{lat:59.9896187,lng:6.0289293}},{title:"Kongeparken",type:filter.getKeywords("landmark"),location:{lat:58.778757,lng:5.84055}},{title:"Utsira",type:filter.getKeywords("landmark"),location:{lat:59.308129,lng:4.8798742}},{title:"Tungenes fyr",type:filter.getKeywords("landmark"),location:{lat:59.0355653,lng:5.5795811}},{title:"Lundeneset VGS",type:filter.getKeywords("landmark"),location:{lat:59.6082346,lng:5.7730419}},{title:"Kjeragbolten",type:filter.getKeywords("hike"),location:{lat:59.0346734,lng:6.5753282}},{title:"Preikestolen",type:filter.getKeywords("hike"),location:{lat:58.9857634,lng:6.1575914}},{title:"Eikedalen Skisenter",type:filter.getKeywords("hike"),location:{lat:60.4067785,lng:5.9173345}},{title:"Trolltunga",type:filter.getKeywords("hike"),location:{lat:60.124167,lng:6.7378113}},{title:"Ulriken",type:filter.getKeywords("hike"),location:{lat:60.3774889,lng:5.3847581}},{title:"Flor & fjære",type:filter.getKeywords("restaurant"),location:{lat:59.0525365,lng:5.8230277}},{title:"Big Horn Steak House",type:filter.getKeywords("restaurant"),location:{lat:59.411882825000006,lng:5.26830164}},{title:"Døgnvill Burger",type:filter.getKeywords("restaurant"),foursquareID:"52d679b111d25266c4e5516a",location:{title:"Stavanger",lat:58.97089746248487,lng:5.731971859931946}},{title:"Godt Brød",type:filter.getKeywords("restaurant"),foursquareID:"5437ab1a498eaaadad1694b3",location:{title:"Fløyen",lat:60.392535236019825,lng:5.329849650529285}}],ajax={title:"",wikipedia:{url:"https://no.wikipedia.org/w/api.php"},flickr:{key:"e896b44b17e42a28558673f7db2b3504",url:"https://www.flickr.com/services/rest/",imgCount:15},nasjonalturbase:{key:"9718dda12c871525b0c2d976e02986c68de29abe",url:"http://api.nasjonalturbase.no/v0/turer/"},foursquare:{client_id:"4XOTGB0SVZCNGUSLZU3NKHLFIYDCGDETYBIGDU3MIGU22APY",client_secret:"SYACHZ3AU3X35J0LN40N1JZ3R2SBVZO0SI33BLCY4VVXNAKO",url:"https://api.foursquare.com/v2/"},openweathermap:{appid:"515c3aceb83a67504fa48539d20aff3a",url:"http://api.openweathermap.org/"},getExternalResources:function(){function e(e,i){$.ajax({url:ajax.foursquare.url+"venues/"+e,dataType:"json",data:{v:Date.now(),ll:markers()[i].position.lat()+","+markers()[i].position.lng(),format:"json",sort:"popular",client_id:ajax.foursquare.client_id,client_secret:ajax.foursquare.client_secret}}).done(function(e){var t,r,a=markers()[i],o=e.response.venue,s=o.photos.groups[0].items;a.foursquare.venue(e.response.venue),a.foursquare.hasContent(!0);for(var n=0;n<s.length;n++){var l=s[n],d=l.user.firstName,c=l.user.lastName||"";t=l.prefix+"579x400"+l.suffix,r={name:d+" "+c},a.foursquare.img.push({url:t,credit:r})}a.foursquare.calculate()}).fail(function(e,t,r){var a=markers()[i];console.error("Foursquare is not responding! (Error code: "+e.status+")"),a.foursquare.hasContent(!0),a.foursquare.error.hasError(!0)})}console.log("Getting external resources!");for(var i=markers().length,t=0;t<i;t++)ajax.title=markers()[t].koTitle(),function(e){$.ajax({url:ajax.wikipedia.url+"?prop=info%7Cextracts",dataType:"jsonp",data:{titles:ajax.title,action:"query",prop:"info|extracts",inprop:"url",format:"json"}}).done(function(i){var t=markers()[e],r=Object.getOwnPropertyNames(i.query.pages)[0],a=i.query.pages,o=a[r].extract;if(o)var s=o.split("</p>");var n="",l="";if(s)if(t.wikipedia.hasContent(!0),s[0].length<=3){l=s[1],articleTextLength=s.length;for(var d=2;d<articleTextLength;d++)n+=s[d]}else{l=s[0],articleTextLength=s.length;for(var d=1;d<articleTextLength;d++)n+=s[d]}t.wikipedia.ingress(l),t.wikipedia.bodyText(n),t.wikipedia.url(a[r].fullurl)}).fail(function(i,t,r){var a=markers()[e];console.error("Wikipedia is not responding! (Error code: "+i.status+")"),a.wikipedia.hasContent(!0),a.wikipedia.error.hasError(!0)})}(t),"Restaurant"!=markers()[t].type.keywords[0]&&!function(e){$.ajax({url:ajax.flickr.url,type:"GET",dataType:"text",data:{method:"flickr.photos.search",sort:"interestingness-desc",extras:"owner_name",text:markers()[e].koTitle(),format:"json",api_key:ajax.flickr.key}}).done(function(i){var t=JSON.parse(i.slice(14,i.length-1)),r=ajax.flickr.imgCount;t.photos.photo.length<ajax.flickr.imgCount&&(r=t.photos.photo.length,console.warn(markers()[e].koTitle()+" doesn't have the desired amout of pictures. ("+t.photos.photo.length+" of the desired "+ajax.flickr.imgCount+")"));for(var a=0;a<r;a++)!function(e,i){$.ajax({url:ajax.flickr.url+"?&?callback=?",dataType:"text",data:{method:"flickr.photos.getSizes",photo_id:t.photos.photo[e].id,format:"json",api_key:ajax.flickr.key}}).done(function(r){if(t.photos.photo[e]){var a=markers()[i],o=JSON.parse(r.slice(14,r.length-1));a.flickr.img.push({url:o.sizes.size[5].source,credit:{name:t.photos.photo[e].ownername}}),a.flickr.hasContent(!0)}}).fail(function(e,i,t){})}(a,e)}).fail(function(i,t,r){console.error("Flickr is not responding! (Error code: "+i.status+")");var a=markers()[e];a.flickr.error.hasError(!0),a.flickr.hasContent(!0)})}(t),"Restaurant"==markers()[t].type.keywords[0]&&(markers()[t].foursquareID?e(markers()[t].foursquareID,t):!function(i){$.ajax({url:ajax.foursquare.url+"venues/search",type:"GET",dataType:"json",data:{v:Date.now(),ll:markers()[i].position.lat()+","+markers()[i].position.lng(),format:"json",client_id:ajax.foursquare.client_id,client_secret:ajax.foursquare.client_secret}}).done(function(t){for(var r=markers()[i],a=0,o=0;o<t.response.venues.length;o++)if(t.response.venues[o].name.toLowerCase().indexOf(r.koTitle().toLowerCase())!==-1){a++;var s=t.response.venues[o];r.foursquareID=s.id,e(s.id,i)}a<1&&console.error("No venues found matching: "+markers()[i].koTitle()+", please add a Foursquare venue id!")}).fail(function(e,t,r){console.error("Foursquare is not responding! (Error code: "+e.status+")");var a=markers()[i];a.foursquare.hasContent(!0),a.foursquare.error.hasError(!0)})}(t)),"Fjelltur"==markers()[t].type.keywords[0]&&!function(e){$.ajax({url:ajax.openweathermap.url+"data/2.5/forecast?",type:"GET",dataType:"json",data:{lat:markers()[e].position.lat(),lon:markers()[e].position.lng(),format:"json",appid:ajax.openweathermap.appid}}).done(function(i){var t=markers()[e];t.openweathermap.data(i),t.openweathermap.hasContent(!0)}).fail(function(i,t,r){var a=markers()[e];console.error("OpenWeatherMaps are not responding! (Error code: "+i.status+")"),a.openweathermap.hasContent(!0),a.openweathermap.error.hasError(!0)})}(t)}},stopZooming=!1,isZooming=!1,newCenter,infoWindow={populate:function(e,i){e.infoWindow||(e.infoWindow=new google.maps.InfoWindow),e.infoWindow.setContent('<div class="info_window"><h5>'+e.title+"</h5><p>"+markers()[e.index].wikipedia.ingress()+'</p><button class="full_width_button" onclick="readMore('+e.index+')">Les meir</button></div>'),e.infoWindow.addListener("closeclick",function(){e.infoWindow.close(),toggleBounce(e)}),e.infoWindow.open(map,e)},closeAll:function(e){for(var i=markers().length,t=0;t<i;t++)e?(markers()[t].koTitle()!==e.koTitle()&&markers()[t].infoWindow&&null!==markers()[t].infoWindow.anchor&&markers()[t].infoWindow.close(),markers()[t].setAnimation(null)):markers()[t].infoWindow&&(markers()[t].infoWindow.close(),markers()[t].setAnimation(null))}};